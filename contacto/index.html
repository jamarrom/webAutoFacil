<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Montserrat:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/reset.css" />
  <link rel="stylesheet" href="../css/globalContacto.css" />
  <link rel="stylesheet" href="../css/contacto.css" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <title>Contacto - AutoF√°cil</title>
  <link rel="icon" type="image/png" href="../favicon.png" sizes="32x32">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  
  <style>
    .custom-marker {
      background: #2563eb;
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 4px solid white;
      box-shadow: 0 3px 12px rgba(0,0,0,0.3);
    }
    .custom-marker::after {
      content: '';
      position: absolute;
      bottom: -10px; left: 50%;
      transform: translateX(-50%);
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 12px solid #2563eb;
    }
    #map { width: 100%; height: 450px; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    
    /* Estilo para bot√≥n deshabilitado */
    .card-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <header class="app-header">
  <div class="header-container">
    <h1 class="header-logo"><span>AutoF√°cil - Cr√©dito Inmediato</span></h1>

    <!-- BOT√ìN HAMBURGUESA -->
    <button class="hamburger" aria-label="Abrir men√∫" id="hamburger">
      <i class="fas fa-bars"></i>
    </button>

    <!-- MEN√ö (full-screen en m√≥vil) -->
    <nav class="header-nav" id="main-nav">
      <ul class="nav-list">
        <li><a href="../" class="nav-link">Inicio</a></li>
        <li><a href="../todos-los-autos" class="nav-link">Todos los autos</a></li>
        <li><a href="../remates" class="nav-link">Remates</a></li>
        <li><a href="/nosotros" class="nav-link">Nosotros</a></li>
        <li><a href="#" class="nav-link active">Contacto</a></li>
      </ul>
    </nav>

    <div class="header-right">
      <div class="social-icons">
        <a href="#"><img src="../img/icons/facebook.svg" alt=""></a>
        <a href="#"><img src="../img/icons/instagram.svg" alt=""></a>
      </div>
      <a href="/contacto" class="btn-demo hover-bright">Agendar Demo</a>
    </div>
  </div>
</header>

  <div class="app">
    <div class="app-contact-page">
      <div class="app-container1">
        <h1 class="app-title">Cont√°ctanos</h1>
        <p class="app-text">
          ¬øTienes preguntas? Estamos aqu√≠ para ayudar. Cont√°ctanos y te responderemos lo antes posible.
        </p>
      </div>

      <div class="app-container2">
        <div class="app-container3">

          <!-- LADO IZQUIERDO - DIN√ÅMICO -->
          <div class="app-container4" id="contact-info">
            <div style="text-align:center; padding:4rem; color:#666; font-size:1.2rem;">
              Cargando informaci√≥n de contacto...
            </div>
          </div>

          <!-- FORMULARIO -->
          <div class="card">
            <h2 class="card-subtitle">Env√≠anos un Mensaje</h2>
            <div class="card-contact-page">
              <div class="container-c container5">
                <p class="container-text2">Nombre Completo *</p>
                <input type="text" id="nombre-input" class="container-input card-light" placeholder="Ingresa tu nombre completo" required>
              </div>
              <div class="container-c container6">
                <p class="container-text2">Correo Electr√≥nico *</p>
                <input type="email" id="email-input" class="container-input card-light" placeholder="Ingresa tu correo electr√≥nico" required>
              </div>
              <div class="container-c container7">
                <p class="container-text2">N√∫mero de Tel√©fono *</p>
                <input type="tel" id="telefono-input" class="container-input card-light" placeholder="Ingresa tu n√∫mero de tel√©fono" required>
              </div>
              <div class="input-group-container">
                <p class="input-group-container-text">Mensaje *</p>
                <textarea id="mensaje-textarea" class="input-group-container-input card-light" rows="5" placeholder="Cu√©ntanos c√≥mo podemos ayudarte..." required></textarea>
              </div>
              <button class="card-btn" id="btn-enviar">Enviar Mensaje</button>
            </div>
          </div>
        </div>

        <!-- MAPA -->
        <div class="map-container" style="margin-top:40px;">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="app-footer">
    <div class="footer-main">
      <div class="footer-brand">
        <img src="../img/logoFooter.png" class="footer-logo" alt="AutoF√°cil Logo" />
        <p class="footer-description">Tu socio confiable para veh√≠culos premium. Calidad, confiabilidad y servicio excepcional.</p>
        <div class="footer-social">
          <a href="#"><img src="../img/icons/facebook.svg" alt="Facebook" class="social-icon" /></a>
          <a href="#"><img src="../img/icons/instagram.svg" alt="Instagram" class="social-icon" /></a>
        </div>
      </div>
      <div class="footer-column">
        <h3 class="footer-heading">Enlaces R√°pidos</h3>
        <ul class="footer-list">
          <li><a href="../">Inicio</a></li>
          <li><a href="../todos-los-autos">Todos los Autos</a></li>
          <li><a href="/nosotros">Nosotros</a></li>
          <li><a href="#">Contacto</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3 class="footer-heading">Servicios</h3>
        <ul class="footer-list">
          <li><a href="#">Comprar un Auto</a></li>
          <li><a href="#">Vender tu Auto</a></li>
          <li><a href="#">Opciones de Financiamiento</a></li>
          <li><a href="#">Valuaci√≥n de Permuta</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3 class="footer-heading">Cont√°ctanos</h3>
        <ul class="footer-contact">
          <li><object data="../assets/app-icon.svg" type="image/svg+xml"></object><span id="footer-address">Cargando...</span></li>
          <li><object data="../assets/list-item/list-item-icon1.svg" type="image/svg+xml"></object><span id="footer-phone">Cargando...</span></li>
          <li><a href="mailto:info@autofacil.com.mx"><object data="../assets/list-item/list-item-icon2.svg" type="image/svg+xml"></object><span id="footer-email">info@autofacil.com.mx</span></a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p class="footer-copyright">¬© 2025 AutoF√°cil - Cr√©dito Inmediato. Todos los derechos reservados.</p>
      <div class="footer-links">
        <a href="#" class="footer-link">Pol√≠tica de Privacidad</a> ‚Ä¢ <a href="#" class="footer-link">T√©rminos y Condiciones</a>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EmailJS (versi√≥n m√°s reciente) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
// ==================== CONFIGURACI√ìN EMAILJS ====================
const EMAILJS_CONFIG = {
  PUBLIC_KEY: 'bmkHjiDnSPtgyB-0y',
  SERVICE_ID: 'service_meuxs3a',
  TEMPLATE_ID: 'template_vbflddt'
};
// ===============================================================

// VARIABLE PARA CONTROLAR ENV√çOS M√öLTIPLES
let isSending = false;

// INICIALIZACI√ìN DE EMAILJS
(function initializeEmailJS() {
  try {
    if (!EMAILJS_CONFIG.PUBLIC_KEY) {
      throw new Error('Public Key no est√° definida');
    }
    
    emailjs.init({
      publicKey: EMAILJS_CONFIG.PUBLIC_KEY,
      blockHeadless: true,
      limitRate: {
        id: 'app',
        throttle: 10000
      }
    });
    
    console.log('‚úÖ EmailJS inicializado correctamente');
    
  } catch (error) {
    console.error('‚ùå Error al inicializar EmailJS:', error);
  }
})();

// Variables globales
const urlParams = new URLSearchParams(window.location.search);
const carId = urlParams.get('id');
let carInfo = null;

// Cargar informaci√≥n de contacto + mapa
async function loadContactInfo() {
  try {
    const res = await fetch('http://54.205.241.136/api/public/contact');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const data = await res.json();

    document.getElementById('contact-info').innerHTML = `
      <div class="container-a container1">
        <div class="container-circle1 circle-blue"><object data="../assets/circle-container/container-icon1.svg"></object></div>
        <div class="container-container1">
          <p class="container-text-heading1">Vis√≠tanos</p>
          <div class="container-paragraph1">${data.address.map(l => `<p class="text">${l}</p>`).join('')}</div>
        </div>
      </div>
      <div class="container-b container2">
        <div class="container-circle2 circle-blue"><object data="../assets/circle-container/container-icon2.svg"></object></div>
        <div class="container-container2">
          <p class="container-text-heading2">Ll√°manos</p>
          <div class="container-paragraph2">${data.phones.map(p => `<p class="text">${p}</p>`).join('')}</div>
        </div>
      </div>
      <div class="container-b container3">
        <div class="container-circle2 circle-blue"><object data="../assets/circle-container/container-icon3.svg"></object></div>
        <div class="container-container2">
          <p class="container-text-heading2">Escr√≠benos</p>
          <div class="container-paragraph2">${data.emails.map(e => `<p class="text"><a href="mailto:${e}" style="color:#64748b;">${e}</a></p>`).join('')}</div>
        </div>
      </div>
      <div class="container-a container4">
        <div class="container-circle1 circle-blue"><object data="../assets/circle-container/container-icon4.svg"></object></div>
        <div class="container-container1">
          <p class="container-text-heading1">Horario de Atenci√≥n</p>
          <div class="container-paragraph1">${data.hours.map(h => `<p class="text">${h}</p>`).join('')}</div>
        </div>
      </div>
    `;

    document.getElementById('footer-address').textContent = data.address[0] || 'Direcci√≥n no disponible';
    document.getElementById('footer-phone').textContent = data.phones[0] || 'Tel√©fono no disponible';
    document.getElementById('footer-email').textContent = data.emails[0] || 'info@autofacil.com.mx';
    document.getElementById('footer-email').parentElement.href = 'mailto:' + (data.emails[0] || 'info@autofacil.com.mx');

    if (data.location && data.location.lat && data.location.lng) {
      initMap(data.location.lat, data.location.lng, data.location.name || 'AutoF√°cil');
    }
    
  } catch (error) { 
    console.error('Error cargando informaci√≥n de contacto:', error);
    document.getElementById('contact-info').innerHTML = `
      <div style="text-align:center; padding:2rem; color:#dc2626;">
        <p>No se pudo cargar la informaci√≥n de contacto</p>
      </div>
    `;
  }
}

// Cargar datos del auto si viene con ?id=
async function loadCarIfNeeded() {
  if (!carId) return;

  try {
    const res = await fetch(`http://54.205.241.136/api/public/car/${carId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    carInfo = await res.json();

    const box = document.createElement('div');
    box.innerHTML = `
      <div style="background:#f8f9fa;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:5px solid #dc2626;">
        <p style="margin:0;font-weight:600;color:#1e293b;">Interesado en:</p>
        <p style="margin:5px 0 0;font-size:1.4rem;color:#dc2626;font-weight:700;">
          ${carInfo.title || 'Auto'} - $${Number(carInfo.price || 0).toLocaleString()}
        </p>
      </div>
    `;
    
    const card = document.querySelector('.card');
    const contactPage = document.querySelector('.card-contact-page');
    if (card && contactPage) {
      card.insertBefore(box, contactPage);
    }
  } catch (error) { 
    console.log('Auto no encontrado:', error);
  }
}

// FUNCI√ìN PRINCIPAL PARA ENVIAR FORMULARIO
async function enviarFormulario() {
  if (isSending) {
    console.log('‚ö†Ô∏è Ya se est√° enviando un mensaje');
    return;
  }
  
  isSending = true;

  if (typeof emailjs === 'undefined') {
    alert('‚ùå El servicio de email no est√° disponible.');
    isSending = false;
    return;
  }

  const nombre = document.getElementById('nombre-input').value.trim();
  const email = document.getElementById('email-input').value.trim();
  const telefono = document.getElementById('telefono-input').value.trim();
  const mensaje = document.getElementById('mensaje-textarea').value.trim();

  if (!nombre || !email || !telefono || !mensaje) {
    alert('‚ùå Todos los campos marcados con * son obligatorios');
    isSending = false;
    return;
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    alert('‚ùå Por favor, ingresa un correo electr√≥nico v√°lido');
    isSending = false;
    return;
  }
  
  const telefonoLimpio = telefono.replace(/\D/g, '');
  if (telefonoLimpio.length < 10) {
    alert('‚ùå Por favor, ingresa un n√∫mero de tel√©fono v√°lido (m√≠nimo 10 d√≠gitos)');
    isSending = false;
    return;
  }

  let mensajeCompleto = `NUEVO CONTACTO DESDE LA WEB\n\n`;
  mensajeCompleto += `üìã Nombre: ${nombre}\n`;
  mensajeCompleto += `üìß Email: ${email}\n`;
  mensajeCompleto += `üì± Tel√©fono: ${telefono}\n`;
  mensajeCompleto += `üí¨ Mensaje: ${mensaje}\n`;

  if (carInfo) {
    mensajeCompleto += `\n--- üöó INTERESADO EN ---\n`;
    mensajeCompleto += `Veh√≠culo: ${carInfo.title || 'Auto'}\n`;
    mensajeCompleto += `Precio: $${Number(carInfo.price || 0).toLocaleString()}\n`;
    mensajeCompleto += `ID: ${carId}\n`;
    mensajeCompleto += `Enlace: ${window.location.origin}/detalle-auto.html?id=${carId}`;
  }

  try {
    const btn = document.getElementById('btn-enviar');
    const originalText = btn.textContent;
    btn.textContent = 'Enviando...';
    btn.disabled = true;

    const templateParams = {
      from_name: nombre,
      from_email: email,
      phone: telefono,
      message: mensajeCompleto,
      reply_to: email,
      date: new Date().toLocaleString('es-MX'),
      car_info: carInfo ? `${carInfo.title} - $${Number(carInfo.price || 0).toLocaleString()}` : 'No especificado'
    };

    console.log('üì§ Enviando email...');

    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );

    console.log('‚úÖ Email enviado exitosamente:', response);
    
    alert('‚úÖ ¬°Mensaje enviado con √©xito!\n\nTe contactaremos pronto.');
    
    // Limpiar formulario
    document.getElementById('nombre-input').value = '';
    document.getElementById('email-input').value = '';
    document.getElementById('telefono-input').value = '';
    document.getElementById('mensaje-textarea').value = '';
    
    // Remover info del auto si exist√≠a
    if (carInfo) {
      const autoBox = document.querySelector('.card > div[style*="background:#f8f9fa"]');
      if (autoBox) autoBox.remove();
      carInfo = null;
    }

  } catch (error) {
    console.error('‚ùå Error al enviar email:', error);
    
    let errorMessage = 'No se pudo enviar el mensaje. ';
    
    if (error.status === 400) {
      errorMessage += 'Error de configuraci√≥n. ';
    } else if (error.status === 429) {
      errorMessage += 'Demasiados intentos. ';
    }
    
    if (error.text) {
      if (error.text.includes('Public Key') || error.text.includes('User ID')) {
        errorMessage += 'Verifica tu configuraci√≥n de EmailJS.';
      } else if (error.text.includes('Service ID')) {
        errorMessage += 'Service ID incorrecto.';
      } else if (error.text.includes('Template ID')) {
        errorMessage += 'Template ID incorrecto.';
      }
    }
    
    alert(`‚ùå ${errorMessage}`);

  } finally {
    const btn = document.getElementById('btn-enviar');
    btn.textContent = 'Enviar Mensaje';
    btn.disabled = false;
    
    setTimeout(() => {
      isSending = false;
    }, 2000);
  }
}

// Funci√≥n para inicializar el mapa
function initMap(lat, lng, name) {
  try {
    if (!lat || !lng) return;
    
    const map = L.map('map').setView([lat, lng], 16);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    const icon = L.divIcon({
      html: '<div class="custom-marker"></div>',
      className: '',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });
    
    L.marker([lat, lng], { icon })
      .addTo(map)
      .bindPopup(`<b>${name || 'AutoF√°cil'}</b>`)
      .openPopup();
      
  } catch (error) {
    console.error('Error al inicializar el mapa:', error);
  }
}

// Cargar todo cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM cargado, iniciando aplicaci√≥n...');
  
  loadContactInfo();
  loadCarIfNeeded();
  
  // Agregar UN SOLO event listener al bot√≥n
  const btn = document.getElementById('btn-enviar');
  if (btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      enviarFormulario();
    });
  }
});
  </script>

  <script>
    // Men√∫ hamburguesa
    const hamburger = document.getElementById('hamburger');
    const nav = document.getElementById('main-nav');

    hamburger.addEventListener('click', () => {
      nav.classList.toggle('open');
      const icon = hamburger.querySelector('i');
      icon.classList.toggle('fa-bars');
      icon.classList.toggle('fa-xmark');
    });

    // Cerrar men√∫ al hacer clic en un enlace (opcional pero queda pro)
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        nav.classList.remove('open');
        hamburger.querySelector('i').classList.add('fa-bars');
        hamburger.querySelector('i').classList.remove('fa-xmark');
      });
    });
  </script>
</body>
</html>